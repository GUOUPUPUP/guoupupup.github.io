<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AI 眼動拼寫器</title>
    <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; overflow: hidden; background: #f0f0f0; }
        #output { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
                  width: 80%; height: 50px; background: white; border: 2px solid #333; 
                  font-size: 24px; display: flex; align-items: center; padding: 10px; z-index: 100; }
        #keyboard { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; 
                    padding: 20px; margin-top: 100px; height: 80vh; }
        .key { background: white; border: 1px solid #ccc; display: flex; 
               align-items: center; justify-content: center; font-size: 2rem; 
               transition: all 0.2s; cursor: pointer; border-radius: 8px; }
        .gaze-focus { background: #ffeb3b !important; transform: scale(1.05); border: 3px solid #f44336; }
    </style>
</head>
<body>

<div id="output">拼寫內容：<span id="text-result"></span></div>
<div id="keyboard" id="keys-container">
    </div>

<script>
    const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ ".split("");
    const keyboard = document.getElementById('keyboard');
    const resultDisplay = document.getElementById('text-result');
    
    let dwellTimer = null;
    let currentKey = null;

    // 1. 初始化鍵盤
    alphabet.forEach(char => {
        const div = document.createElement('div');
        div.className = 'key';
        div.innerText = char === " " ? "SPACE" : char;
        div.dataset.char = char;
        keyboard.appendChild(div);
    });

    // 2. 啟動 Webgazer
    window.onload = async () => {
        await webgazer.setRegression('ridge') 
            .setGazeListener((data, timestamp) => {
                if (data == null) return;
                checkGaze(data.x, data.y);
            }).begin();

        // 隱藏攝影機預覽的小視窗或調整位置
        webgazer.showVideoPreview(true).showPredictionPoints(true);
    };

    // 3. 視線邏輯判定
    function checkGaze(x, y) {
        const target = document.elementFromPoint(x, y);
        
        if (target && target.classList.contains('key')) {
            if (currentKey !== target) {
                clearTimeout(dwellTimer);
                if (currentKey) currentKey.classList.remove('gaze-focus');
                
                currentKey = target;
                currentKey.classList.add('gaze-focus');
                
                // 停留超過 1.2 秒則輸入字母
                dwellTimer = setTimeout(() => {
                    resultDisplay.innerText += currentKey.dataset.char;
                    // 輸入後暫時震動提醒（選配）
                    if (navigator.vibrate) navigator.vibrate(50);
                }, 1200);
            }
        } else {
            if (currentKey) {
                currentKey.classList.remove('gaze-focus');
                clearTimeout(dwellTimer);
                currentKey = null;
            }
        }
    }
</script>

</body>
</html>