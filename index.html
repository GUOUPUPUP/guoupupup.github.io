<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AI 眼動拼寫器 - 專業校準版</title>
    <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f0f0f0; }
        /* 校準點樣式 */
        .calibration-point {
            width: 20px; height: 20px; background: red; border-radius: 50%;
            position: fixed; cursor: pointer; z-index: 999; border: 2px solid white;
        }
        #output { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
                  width: 80%; height: 60px; background: white; border: 2px solid #333; 
                  font-size: 24px; display: none; align-items: center; padding: 0 15px; z-index: 100; }
        #keyboard { display: none; grid-template-columns: repeat(7, 1fr); gap: 10px; 
                    padding: 20px; margin-top: 100px; height: 80vh; }
        .key { background: white; border: 1px solid #ccc; display: flex; 
               align-items: center; justify-content: center; font-size: 2rem; 
               transition: 0.2s; border-radius: 8px; }
        .gaze-focus { background: #ffeb3b !important; transform: scale(1.05); border: 2px solid orange; }
        #instructions { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                        text-align: center; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div id="instructions">
    <h2>眼動儀校準</h2>
    <p>請用眼睛盯著紅色點，並用滑鼠點擊它。<br>每個點點擊 5 次，直到點變為綠色。</p>
    <button onclick="startCalibration()">開始校準</button>
</div>

<div id="output">拼寫：<span id="text-result"></span></div>
<div id="keyboard"></div>

<div id="calibration-overlay" style="display:none;">
    <div class="calibration-point" style="top: 10%; left: 10%;" data-count="0"></div>
    <div class="calibration-point" style="top: 10%; left: 50%;" data-count="0"></div>
    <div class="calibration-point" style="top: 10%; left: 90%;" data-count="0"></div>
    <div class="calibration-point" style="top: 50%; left: 10%;" data-count="0"></div>
    <div class="calibration-point" style="top: 50%; left: 50%;" data-count="0"></div>
    <div class="calibration-point" style="top: 50%; left: 90%;" data-count="0"></div>
    <div class="calibration-point" style="top: 90%; left: 10%;" data-count="0"></div>
    <div class="calibration-point" style="top: 90%; left: 50%;" data-count="0"></div>
    <div class="calibration-point" style="top: 90%; left: 90%;" data-count="0"></div>
</div>

<script>
    const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ ".split("");
    let dwellTimer = null, currentKey = null, pointsClicked = 0;

    function startCalibration() {
        document.getElementById('instructions').style.display = 'none';
        document.getElementById('calibration-overlay').style.display = 'block';
        
        webgazer.setRegression('ridge')
            .setGazeListener((data, timestamp) => {
                if (data && document.getElementById('keyboard').style.display === 'grid') {
                    checkGaze(data.x, data.y);
                }
            }).begin();
        
        webgazer.applyKalmanFilter(true); // 啟用濾波器減少跳動
        webgazer.showVideoPreview(true).showPredictionPoints(true);
    }

    // 點擊校準點邏輯
    document.querySelectorAll('.calibration-point').forEach(pt => {
        pt.addEventListener('click', function() {
            let count = parseInt(this.dataset.count) + 1;
            this.dataset.count = count;
            this.style.opacity = 1 - (count * 0.15); // 點擊越多次越透明
            
            if (count >= 5) {
                this.style.background = 'green';
                this.style.pointerEvents = 'none';
                pointsClicked++;
                if (pointsClicked >= 9) finishCalibration();
            }
        });
    });

    function finishCalibration() {
        document.getElementById('calibration-overlay').style.display = 'none';
        document.getElementById('keyboard').style.display = 'grid';
        document.getElementById('output').style.display = 'flex';
        initKeyboard();
    }

    function initKeyboard() {
        const kb = document.getElementById('keyboard');
        kb.innerHTML = '';
        alphabet.forEach(char => {
            const div = document.createElement('div');
            div.className = 'key';
            div.innerText = char === " " ? "SPACE" : char;
            div.dataset.char = char;
            kb.appendChild(div);
        });
    }

    function checkGaze(x, y) {
        const target = document.elementFromPoint(x, y);
        if (target && target.classList.contains('key')) {
            if (currentKey !== target) {
                clearTimeout(dwellTimer);
                if (currentKey) currentKey.classList.remove('gaze-focus');
                currentKey = target;
                currentKey.classList.add('gaze-focus');
                dwellTimer = setTimeout(() => {
                    document.getElementById('text-result').innerText += currentKey.dataset.char;
                }, 1500); // 增加到 1.5 秒減少誤觸
            }
        } else {
            if (currentKey) {
                currentKey.classList.remove('gaze-focus');
                clearTimeout(dwellTimer);
                currentKey = null;
            }
        }
    }
</script>
</body>
</html>
